<!DOCTYPE html>
<html>
<head>
    <title>Room</title>
    <style>
#mySquare{
        width: 100px;
        height: 100px;
        background-color: black;
        position: relative;
      }
      #mySquare::before {
        content: "";
        display: block;
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: yellow;
        opacity: 0;
        transition: opacity 0.3s ease-in-out;
      }
      #myButton:checked ~ #mySquare::before {
        background-color: black;
        opacity: 1;
      }
      #myButton2:checked ~ #mySquare::before {
        background-color: yellow;
        opacity: 1;
      }
      #mySquare.on {
        background-color: yellow;
      }
      #mySquare.off {
        background-color: black;
      }
    </style>
</head>
<body>
<h3>Your room</h3>

<form method="post" id="room-form" data-room-id="${id}">
    <input type="radio" id="myButton" name="button" value="off" checked>
    <label for="myButton">Turn off light</label>
    <input type="radio" id="myButton2" name="button" value="on">
    <label for="myButton2">Turn on light</label><br><br>


    <div id="mySquare"></div><br>
</form>

<a href="/">Back to the main page</a><br><br>
<a href="/rooms">All rooms</a>



<script>
  // ѕолучаем ID комнаты из параметра URL

  const roomId = window.location.pathname.split('/').pop();

  // ѕолучаем сохраненное состо€ние из localStorage
  const savedState = localStorage.getItem(`room-${roomId}-state`);

  // ”станавливаем начальное состо€ние радиокнопок и квадрата
  if (savedState === 'on') {
    document.getElementById("myButton2").checked = true;
    document.getElementById("mySquare").classList.add("on");
  } else if (savedState === 'off') {
    document.getElementById("myButton").checked = true;
    document.getElementById("mySquare").classList.remove("on");
  }

  // —охран€ем состо€ние в localStorage и отправл€ем сообщение на сервер при изменении радиокнопок
  // ѕолучаем все радиокнопки на странице
  const radioButtons = document.querySelectorAll('input[name="button"]');
  // —оздаем новое WebSocket-соединение на сервере
  const socket = new WebSocket("ws://" + window.location.host + "/socket?room=" + roomId);

  // ƒобавл€ем обработчик изменени€ состо€ни€ радиокнопок
  radioButtons.forEach((button) => {
    button.addEventListener('change', (event) => {
      const newState = event.target.value;
      const currentRoomId = event.target.closest("form").getAttribute("data-room-id");
      // ѕровер€ем, изменилось ли сохраненное состо€ние и отправл€ем сообщение на сервер
      if (localStorage.getItem(`room-${currentRoomId}-state`) !== newState) {
        localStorage.setItem(`room-${currentRoomId}-state`, newState);
        socket.send(newState);
      }
      // »змен€ем состо€ние квадрата на странице на основе выбранной радиокнопки
      if (newState === "on") {
        document.getElementById("mySquare").classList.add("on");
      } else {
        document.getElementById("mySquare").classList.remove("on");
      }
    });
  });

  // ”станавливаем начальное состо€ние радиокнопок и квадрата на основе сообщени€ от сервера
  socket.onmessage = function(event) {
    const data = event.data;
    if (data === "on") {
      document.getElementById("myButton2").checked = true;
      document.getElementById("mySquare").classList.add("on");
    } else if (data === "off") {
      document.getElementById("myButton").checked = true;
      document.getElementById("mySquare").classList.remove("on");
    }
  };

  // ”станавливаем начальное состо€ние радиокнопок и квадрата на основе сохраненного значени€
  const currentRoomId = document.getElementById("room-form").getAttribute("data-room-id");
  if (currentRoomId === roomId) {
    const savedState = localStorage.getItem(`room-${roomId}-state`);
    if (savedState === 'on') {
      document.getElementById("myButton2").checked = true;
      document.getElementById("mySquare").classList.add("on");
    } else if (savedState === 'off') {
      document.getElementById("myButton").checked = true;
      document.getElementById("mySquare").classList.remove("on");
    }
  }

  // ”станавливаем начальное состо€ние радиокнопок и квадрата на основе сохраненного значени€ при загрузке страницы
  window.addEventListener("load", function() {
    const savedState = localStorage.getItem(`room-${roomId}-state`);
    if (savedState === 'on') {
      document.getElementById("myButton2").checked = true;
      document.getElementById("mySquare").classList.add("on");
    } else if (savedState === 'off') {
      document.getElementById("myButton").checked = true;
      document.getElementById("mySquare").classList.remove("on");
    }
  });


  // —охран€ем состо€ние в localStorage при выходе из комнаты
  window.addEventListener("beforeunload", function() {
    const selectedValue = document.querySelector('input[name="button"]:checked').value;
    const currentRoomId = document.getElementById('room-form').getAttribute("data-room-id");
    localStorage.setItem(`room-${roomId}-state`, selectedValue);
  });

</script>

</body>
</html>