<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Your room</title>
    <style>
      #mySquare{
        width: 100px;
        height: 100px;
        background-color: black;
        position: relative;
      }
      #mySquare::before {
        content: "";
        display: block;
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: yellow;
        opacity: 0;
        transition: opacity 0.3s ease-in-out;
      }
      #myButton:checked ~ #mySquare-${roomId}::before {
        background-color: black;
        opacity: 1;
      }
      #myButton2:checked ~ #mySquare-${roomId}::before {
        background-color: yellow;
        opacity: 1;
      }
      #mySquare.on {
        background-color: yellow;
      }
      #mySquare.off {
        background-color: black;
      }
  </style>
</head>
<body>
<h3>Your room</h3>

<form method="get" id="room-form">
    <input type="radio" id="myButton" name="button" value="off" checked>
    <label for="myButton">Turn off light</label>
    <input type="radio" id="myButton2" name="button" value="on">
    <label for="myButton2">Turn on light</label><br><br>

    <div id="mySquare"></div><br><br>
</form>

<a href="/">Back to the main page</a><br><br>
<a href="/rooms">All rooms</a>

<script>
  // Get room ID from URL parameter
  const urlParams = new URLSearchParams(window.location.search);
  const roomId = urlParams.get('id');

  // Get saved state from localStorage
  const savedState = localStorage.getItem(`room-${roomId}-state`);

  // Set initial state of radio buttons and square
  if (savedState === 'on') {
    document.getElementById("myButton2").checked = true;
    document.getElementById("mySquare").classList.add("on");
  } else if (savedState === 'off') {
    document.getElementById("myButton").checked = true;
    document.getElementById("mySquare").classList.remove("on");
  }

  // Save state to localStorage and send message to server on radio button change
  const radioButtons = document.querySelectorAll('input[name="button"]');
  const socket = new WebSocket("ws://" + location.host + "/socket");

radioButtons.forEach((button) => {
  button.addEventListener('change', (event) => {
    const newState = event.target.value;
    const currentRoomId = event.target.closest("form").getAttribute("data-room-id");
    if (localStorage.getItem(`room-${currentRoomId}-state`) !== newState) {
      localStorage.setItem(`room-${currentRoomId}-state`, newState);
      socket.send(newState);
    }
    if (newState === "on") {
      document.getElementById("mySquare").classList.add("on");
    } else {
      document.getElementById("mySquare").classList.remove("on");
    }
  });
});


  // Set initial state of radio buttons and square from server message
  socket.onmessage = function(event) {
    const data = event.data;
    if (data === "on") {
      document.getElementById("myButton2").checked = true;
      document.getElementById("mySquare").classList.add("on");
    } else if (data === "off") {
      document.getElementById("myButton").checked = true;
      document.getElementById("mySquare").classList.remove("on");
    }
  };

  // Set initial state of radio buttons and square from saved value
  const currentRoomId = document.getElementById("room-form").getAttribute("data-room-id");
  if (currentRoomId === roomId) {
    const savedState = localStorage.getItem(`room-${roomId}-state`);
    if (savedState === 'on') {
      document.getElementById("myButton2").checked = true;
      document.getElementById("mySquare").classList.add("on");
    } else if (savedState === 'off') {
      document.getElementById("myButton").checked = true;
      document.getElementById("mySquare").classList.remove("on");
    }
  }

    window.addEventListener("beforeunload", function() {
      const selectedValue = document.querySelector('input[name="button"]:checked').value;
      const currentRoomId = document.getElementById('room-form').getAttribute("data-room-id");
      localStorage.setItem(`room-${currentRoomId}-state`, selectedValue);
    });

</script>


</body>
</html>


